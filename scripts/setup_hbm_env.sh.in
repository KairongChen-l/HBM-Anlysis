#!/bin/bash
# 此脚本设置分析HPC应用所需的环境变量

# 安装路径
HBM_INSTALL_DIR="@CMAKE_INSTALL_PREFIX@"
LLVM_LIBRARY_DIR="@LLVM_LIBRARY_DIR@"
PLUGIN_PATH="${LLVM_LIBRARY_DIR}/Transforms/AdvancedHBMPlugin.so"

echo "Setting up environment for Advanced HBM Analysis..."

# 检查插件是否存在
if [ ! -f "${PLUGIN_PATH}" ]; then
    echo "Error: HBM plugin not found at ${PLUGIN_PATH}"
    echo "Please check your installation or build the plugin first."
    exit 1
fi

# 为C编译器设置环境变量
export CC="clang"
export CFLAGS="-flto=thin"

# 为C++编译器设置环境变量
export CXX="clang++"
export CXXFLAGS="-flto=thin"

# 设置链接器选项
export LDFLAGS="-Wl,-plugin-opt=load=${PLUGIN_PATH}"

# 如果只需要分析模式
if [ "$1" = "--analysis-only" ]; then
    export LDFLAGS="${LDFLAGS} -Wl,-plugin-opt=opt-arg=-hbm-analysis-only"
    echo "Analysis-only mode enabled."
fi

# 设置报告输出位置
if [ -n "$2" ]; then
    REPORT_PATH="$2"
else
    REPORT_PATH="hbm_report.json"
fi

export LDFLAGS="${LDFLAGS} -Wl,-plugin-opt=opt-arg=-hbm-report-file=${REPORT_PATH}"

# 设置额外的库路径
export LD_LIBRARY_PATH="${HBM_INSTALL_DIR}/lib:${LD_LIBRARY_PATH}"

echo "Environment setup complete!"
echo "CC:       ${CC}"
echo "CFLAGS:   ${CFLAGS}"
echo "CXX:      ${CXX}"
echo "CXXFLAGS: ${CXXFLAGS}"
echo "LDFLAGS:  ${LDFLAGS}"
echo "Report will be generated at: ${REPORT_PATH}"
echo ""
echo "To compile your HPC application with HBM analysis:"
echo "  1. Source this script:       source setup_hbm_env.sh [--analysis-only] [report_path]"
echo "  2. Run your normal build:    ./configure && make"
echo ""